# Use Cases - Authentication System

Tài liệu này mô tả các Use Cases cho hệ thống xác thực của Shoes Shopping Online System, bao gồm Swimlane Diagrams và
Functional Requirements.

---

## UC-01: User Login

### Functional Requirement

| **Field**             | **Content**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ID and Name**       | UC-01 User Login                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Created By**        | System Analyst                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Date Created**      | 26/01/2026                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Primary Actor**     | Customer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Secondary Actors**  | Frontend Application, Keycloak, Backend API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description**       | This use case allows the Customer to authenticate and access the system using username/email and password credentials.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Trigger**           | Customer clicks Login button on the application homepage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Preconditions**     | PRE-1: Customer has a registered account in the system.<br>PRE-2: Frontend application is accessible.<br>PRE-3: Keycloak authentication server is running.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Postconditions**    | POST-1: Customer is authenticated and redirected to the application.<br>POST-2: JWT access token is stored in browser localStorage.<br>POST-3: User session is established.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Normal Flow**       | 1. Customer clicks "Login" button on the application homepage.<br>2. Frontend redirects Customer to Keycloak login page.<br>3. Customer enters username/email and password on Keycloak login page.<br>4. Customer clicks "Login" button on Keycloak page.<br>5. Keycloak validates credentials against user database.<br>6. Keycloak generates JWT access token and ID token.<br>7. Keycloak redirects to Frontend callback URL with authorization code.<br>8. Frontend exchanges authorization code for tokens.<br>9. Frontend stores tokens in localStorage.<br>10. Frontend redirects Customer to the application homepage.<br>11. System displays authenticated user menu. |
| **Alternative Flows** | **A1: Invalid Credentials**<br>4a. Customer enters incorrect username or password on Keycloak page.<br>4b. Keycloak returns authentication error.<br>4c. Keycloak displays error message "Invalid username or password" on login page.<br>4d. Use case resumes at step 3.<br><br>**A2: Account Locked**<br>5a. Keycloak detects account is locked/temporarily disabled.<br>5b. Keycloak returns account locked error.<br>5c. Keycloak displays error message "Account is temporarily locked".<br>5d. Use case ends.                                                                                                                                                            |
| **Exceptions**        | **E1: Keycloak Server Unavailable**<br>5a. Keycloak server is down or unreachable.<br>5b. Frontend displays error message "Authentication service is temporarily unavailable".<br>5c. Use case ends.<br><br>**E2: Network Error**<br>7a. Network connection fails during token exchange.<br>7b. Frontend displays error message "Network error. Please try again".<br>7c. Use case resumes at step 1.                                                                                                                                                                                                                                                                          |
| **Priority**          | High                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Business Rules**    | BR-1: Password must meet complexity requirements (min 8 characters, uppercase, lowercase, number).<br>BR-2: Failed login attempts are logged for security monitoring.<br>BR-3: JWT token expires after 5 minutes, refresh token expires after 30 days.                                                                                                                                                                                                                                                                                                                                                                                                                         |

### Swimlane Diagram

```mermaid
sequenceDiagram
    participant Customer
    participant Frontend
    participant Keycloak
    participant Backend
    participant Database

    Customer->>Frontend: 1. Click Login button
    Frontend->>Keycloak: 2. Redirect to Keycloak login
    Keycloak->>Customer: 3. Display Keycloak login page
    Customer->>Keycloak: 4. Enter username/password
    Customer->>Keycloak: 5. Click Login button
    Keycloak->>Database: 6. Validate credentials
    Database-->>Keycloak: 7. User data
    alt Valid credentials
        Keycloak->>Keycloak: 8. Generate JWT tokens
        Keycloak->>Frontend: 9. Redirect with auth code
        Frontend->>Keycloak: 10. Exchange code for tokens
        Keycloak-->>Frontend: 11. Return access_token & id_token
        Frontend->>Frontend: 12. Store tokens in localStorage
        Frontend->>Customer: 13. Redirect to homepage
        Customer->>Frontend: 14. Access authenticated pages
        Frontend->>Backend: 15. API request with Bearer token
        Backend->>Keycloak: 16. Validate JWT token
        Keycloak-->>Backend: 17. Token valid
        Backend-->>Frontend: 18. Return data
    else Invalid credentials
        Keycloak->>Customer: Error: Invalid credentials
        Note over Keycloak: Display error on Keycloak page
    end
```

---

## UC-02: User Registration

### Functional Requirement

| **Field**             | **Content**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ID and Name**       | UC-02 User Registration                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Created By**        | System Analyst                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Date Created**      | 26/01/2026                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Primary Actor**     | Customer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Secondary Actors**  | Frontend Application, Keycloak, Backend API, Email Service                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Description**       | This use case allows a new Customer to create an account in the system by providing personal information and credentials.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Trigger**           | Customer clicks "Register" or "Sign Up" link on the login page.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Preconditions**     | PRE-1: Customer does not have an existing account.<br>PRE-2: Frontend application is accessible.<br>PRE-3: Keycloak authentication server is running.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Postconditions**    | POST-1: New user account is created in Keycloak.<br>POST-2: Verification email is sent to Customer's email address.<br>POST-3: Customer is redirected to email verification page (registration successful).<br>POST-4: User record synchronization to Backend database is initiated via webhook (background process).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Normal Flow**       | 1. Customer clicks "Register" link on login page.<br>2. Frontend redirects to Keycloak registration page.<br>3. Customer fills registration form (username, email, password, firstName, lastName).<br>4. Customer accepts terms and conditions (if required).<br>5. Customer clicks "Register" button.<br>6. Keycloak validates form data (email format, password strength, username uniqueness).<br>7. Keycloak creates new user account.<br>8. Keycloak triggers REGISTER event (synchronous event handler).<br>9. Custom Event Listener receives REGISTER event and calls webhook to Backend API (synchronous HTTP call, but failures are caught and logged).<br>10. Backend API receives user data via webhook and creates/updates User record in database.<br>11. Keycloak sends email verification email to Customer.<br>12. Keycloak redirects Customer to email verification info page.<br>13. Customer sees "Please verify your email" message (registration successful).<br>14. Customer receives verification email.                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Alternative Flows** | **A1: Email Already Exists**<br>6a. Keycloak detects email already registered.<br>6b. Keycloak returns validation error.<br>6c. Frontend displays error message "Email already exists".<br>6d. Use case resumes at step 3.<br><br>**A2: Username Already Exists**<br>6a. Keycloak detects username already taken.<br>6b. Keycloak returns validation error.<br>6c. Frontend displays error message "Username already taken".<br>6d. Use case resumes at step 3.<br><br>**A3: Weak Password**<br>6a. Keycloak detects password does not meet requirements.<br>6b. Keycloak returns validation error.<br>6c. Frontend displays error message "Password must be at least 8 characters with uppercase, lowercase, and number".<br>6d. Use case resumes at step 3.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Exceptions**        | **E1: Keycloak Server Unavailable**<br>7a. Keycloak server is down during registration.<br>7b. Frontend displays error message "Registration service is temporarily unavailable".<br>7c. Use case ends.<br><br>**E2: Webhook Failure**<br>9a. Backend API webhook endpoint is unavailable, timeout, or returns error status code.<br>9b. Custom Event Listener catches IOException/RuntimeException in `sendUserData()` method.<br>9c. Error is logged via `log.errorf("Failed to call API: %s", e)` but exception is NOT re-thrown.<br>9d. Registration flow continues normally (exception handling prevents webhook failure from affecting registration).<br>9e. User account is successfully created in Keycloak (registration is successful from Customer perspective).<br>9f. User record is not synchronized to Backend database.<br>9g. System administrator is notified via Keycloak logs.<br>9h. Use case continues normally (Customer sees success message and can verify email).<br>9i. Backend can retry synchronization later via scheduled job or manual intervention.<br><br>**E3: Email Service Failure**<br>11a. Email service fails to send verification email.<br>11b. Keycloak logs error.<br>11c. Keycloak still redirects Customer to verification page.<br>11d. Customer is informed to contact support if email is not received.<br>11e. Registration is still considered successful (user account created). |
| **Priority**          | High                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Business Rules**    | BR-1: Email address must be unique in the system.<br>BR-2: Username must be unique and between 3-20 characters.<br>BR-3: Password must meet complexity requirements.<br>BR-4: Email verification is required before account activation.<br>BR-5: Registration success is determined by Keycloak user creation, not webhook completion.<br>BR-6: Webhook call is made synchronously in the REGISTER event handler, but exceptions are caught and logged without affecting registration flow.<br>BR-7: Webhook failures are logged via Keycloak logs but do not prevent user from completing registration flow.<br>BR-8: If webhook is slow, it may delay Keycloak response, but if webhook fails, registration still succeeds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

### Swimlane Diagram

```mermaid
sequenceDiagram
    participant Customer
    participant Frontend
    participant Keycloak
    participant EventListener
    participant Backend
    participant Database
    participant EmailService

    Customer->>Frontend: 1. Click Register
    Frontend->>Keycloak: 2. Redirect to registration page
    Keycloak->>Customer: 3. Display registration form
    Customer->>Keycloak: 4. Fill form & submit
    Keycloak->>Keycloak: 5. Validate form data
    alt Valid data
        Keycloak->>Keycloak: 6. Create user account
        Keycloak->>Keycloak: 7. Trigger REGISTER event (synchronous)
        Keycloak->>EventListener: 8. Event notification
        EventListener->>Backend: 9. POST /keycloak/webhook/user-registration<br/>(synchronous HTTP call)
        alt Webhook success
            Backend->>Database: 10. Create/Update User record
            Database-->>Backend: 11. User saved
            Backend-->>EventListener: 12. Success response
            EventListener-->>Keycloak: Continue registration flow
        else Webhook failure
            EventListener->>EventListener: Catch exception & log error<br/>(does not throw)
            Note over EventListener: log.errorf("Failed to call API")<br/>Registration continues
        end
        Keycloak->>EmailService: 13. Send verification email
        EmailService->>Customer: 14. Email delivered (async)
        Keycloak->>Frontend: 15. Redirect to verification page
        Frontend->>Customer: 16. Display "Verify email" message<br/>(Registration SUCCESS)
    else Invalid data
        Keycloak->>Customer: Error: Validation failed
        Note over Keycloak: Display error on Keycloak page
    end
```

---

## UC-03: Forgot Password

### Functional Requirement

| **Field**             | **Content**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|-----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ID and Name**       | UC-03 Forgot Password                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Created By**        | System Analyst                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Date Created**      | 26/01/2026                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Primary Actor**     | Customer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Secondary Actors**  | Frontend Application, Keycloak, Email Service                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description**       | This use case allows Customer to reset their password by requesting a password reset link via email.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Trigger**           | Customer clicks "Forgot Password" link on the login page.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Preconditions**     | PRE-1: Customer has a registered account.<br>PRE-2: Customer knows their registered email address or username.<br>PRE-3: Email service is configured and operational.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Postconditions**    | POST-1: Password reset email is sent to Customer's registered email.<br>POST-2: Password reset link is generated with expiration time.<br>POST-3: Customer can access password reset page via link.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Normal Flow**       | 1. Customer clicks "Forgot Password" link on login page.<br>2. Frontend redirects to Keycloak password reset page.<br>3. Customer enters username or email address.<br>4. Customer clicks "Submit" button.<br>5. Keycloak validates username/email exists in system.<br>6. Keycloak generates password reset token with expiration (e.g., 1 hour).<br>7. Keycloak sends password reset email with reset link.<br>8. Email service delivers email to Customer.<br>9. Customer receives email and clicks reset link.<br>10. Keycloak validates reset token (checks expiration and validity).<br>11. Keycloak displays password reset form.<br>12. Customer enters new password and confirms.<br>13. Keycloak validates new password meets requirements.<br>14. Keycloak updates user password.<br>15. Keycloak invalidates reset token.<br>16. Keycloak redirects Customer to login page with success message.<br>17. Customer can login with new password. |
| **Alternative Flows** | **A1: Username/Email Not Found**<br>5a. Keycloak cannot find user with provided username/email.<br>5b. Keycloak still displays success message (security: prevent user enumeration).<br>5c. No email is sent.<br>5d. Use case ends.<br><br>**A2: Reset Link Expired**<br>10a. Customer clicks reset link after expiration time.<br>10b. Keycloak detects expired token.<br>10c. Keycloak displays error "Reset link has expired".<br>10d. Keycloak provides option to request new reset link.<br>10e. Use case resumes at step 1.<br><br>**A3: Weak New Password**<br>13a. New password does not meet requirements.<br>13b. Keycloak returns validation error.<br>13c. Frontend displays error message.<br>13d. Use case resumes at step 12.                                                                                                                                                                                                              |
| **Exceptions**        | **E1: Email Service Failure**<br>7a. Email service fails to send reset email.<br>7b. Keycloak logs error.<br>7c. Customer is informed to contact support or try again later.<br>7d. Use case ends.<br><br>**E2: Invalid Reset Token**<br>10a. Reset token is invalid or already used.<br>10b. Keycloak displays error "Invalid reset link".<br>10c. Customer must request new reset link.<br>10d. Use case resumes at step 1.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Priority**          | High                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Business Rules**    | BR-1: Password reset link expires after 1 hour.<br>BR-2: Reset token can only be used once.<br>BR-3: For security, system does not reveal if email/username exists.<br>BR-4: New password must meet complexity requirements.<br>BR-5: Password reset attempts are logged for security monitoring.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

### Swimlane Diagram

```mermaid
sequenceDiagram
    participant Customer
    participant Frontend
    participant Keycloak
    participant EmailService

    Customer->>Frontend: 1. Click Forgot Password
    Frontend->>Keycloak: 2. Redirect to reset page
    Keycloak->>Customer: 3. Display reset form
    Customer->>Keycloak: 4. Enter username/email & submit
    Keycloak->>Keycloak: 5. Validate user exists
    alt User found
        Keycloak->>Keycloak: 6. Generate reset token
        Keycloak->>EmailService: 7. Send reset email
        EmailService->>Customer: 8. Email delivered
        Customer->>Keycloak: 9. Click reset link
        Keycloak->>Keycloak: 10. Validate token
        alt Token valid
            Keycloak->>Customer: 11. Display password reset form
            Customer->>Keycloak: 12. Enter new password
            Keycloak->>Keycloak: 13. Validate password
            Keycloak->>Keycloak: 14. Update password
            Keycloak->>Keycloak: 15. Invalidate token
            Keycloak->>Frontend: 16. Redirect to login
            Frontend->>Customer: 17. Display success message
        else Token expired/invalid
            Keycloak->>Customer: Error: Link expired
        end
    else User not found
        Keycloak->>Customer: Success message (security)
    end
```

---

## UC-04: Login with Google

### Functional Requirement

| **Field**             | **Content**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|-----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **ID and Name**       | UC-04 Login with Google                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Created By**        | System Analyst                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Date Created**      | 26/01/2026                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Primary Actor**     | Customer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Secondary Actors**  | Frontend Application, Keycloak, Google OAuth Service, Backend API                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description**       | This use case allows Customer to authenticate using their Google account through OAuth2/OIDC protocol without entering username and password.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Trigger**           | Customer clicks "Login with Google" button on the login page.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Preconditions**     | PRE-1: Customer has a Google account.<br>PRE-2: Google Identity Provider is configured in Keycloak.<br>PRE-3: Frontend application is accessible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Postconditions**    | POST-1: Customer is authenticated via Google account.<br>POST-2: If new user, account is created in Keycloak and Backend database.<br>POST-3: JWT access token is stored in browser localStorage.<br>POST-4: Customer is redirected to the application.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Normal Flow**       | 1. Customer clicks "Login with Google" button on login page.<br>2. Frontend redirects to Keycloak OAuth endpoint.<br>3. Keycloak redirects Customer to Google OAuth consent screen.<br>4. Customer signs in with Google credentials (if not already signed in).<br>5. Customer grants permission to application (if first time).<br>6. Google redirects back to Keycloak with authorization code.<br>7. Keycloak exchanges authorization code for Google access token.<br>8. Keycloak retrieves user profile from Google (email, name, etc.).<br>9. Keycloak checks if user exists in Keycloak database.<br>10. If user exists: Keycloak authenticates user.<br>11. If user does not exist: Keycloak creates new user account with Google profile data.<br>12. Keycloak triggers REGISTER event (if new user).<br>13. Custom Event Listener sends webhook to Backend API (if new user).<br>14. Backend API creates User record in database (if new user).<br>15. Keycloak generates JWT access token and ID token.<br>16. Keycloak redirects to Frontend callback URL with authorization code.<br>17. Frontend exchanges authorization code for tokens.<br>18. Frontend stores tokens in localStorage.<br>19. Frontend redirects Customer to the application homepage.<br>20. System displays authenticated user menu. |
| **Alternative Flows** | **A1: User Denies Permission**<br>5a. Customer denies permission to access Google account.<br>5b. Google redirects back with error.<br>5c. Keycloak displays error message.<br>5d. Frontend redirects Customer back to login page.<br>5e. Use case ends.<br><br>**A2: Google Account Not Verified**<br>8a. Google account email is not verified.<br>8b. Keycloak may reject or require email verification.<br>8c. Customer is informed to verify Google email first.<br>8d. Use case ends.<br><br>**A3: Existing User with Different Email**<br>9a. Google email matches existing Keycloak user email.<br>9b. Keycloak links Google identity to existing account.<br>9c. Customer is authenticated successfully.<br>9d. Use case continues at step 15.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Exceptions**        | **E1: Google OAuth Service Unavailable**<br>3a. Google OAuth service is down or unreachable.<br>3b. Keycloak displays error "Google authentication service unavailable".<br>3c. Customer is redirected back to login page.<br>3d. Use case ends.<br><br>**E2: Keycloak Google Configuration Error**<br>7a. Keycloak Google Identity Provider configuration is incorrect.<br>7b. Token exchange fails.<br>7c. Keycloak logs error.<br>7d. Customer sees generic error message.<br>7e. Use case ends.<br><br>**E3: Webhook Failure (New User)**<br>13a. Backend API webhook endpoint is unavailable for new user.<br>13b. Keycloak logs error but continues authentication.<br>13c. User account is created in Keycloak but not in Backend database.<br>13d. System administrator is notified.<br>13e. Use case continues (user can still access application).                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Priority**          | High                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Business Rules**    | BR-1: Google Identity Provider must be configured in Keycloak with valid Client ID and Secret.<br>BR-2: First-time Google login automatically creates user account.<br>BR-3: User data from Google (email, firstName, lastName) is synchronized to Backend via webhook.<br>BR-4: Google email is used as the primary identifier for the account.<br>BR-5: Customer can link multiple identity providers to the same account.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

### Swimlane Diagram

```mermaid
sequenceDiagram
    participant Customer
    participant Frontend
    participant Keycloak
    participant Google
    participant EventListener
    participant Backend
    participant Database

    Customer->>Frontend: 1. Click "Login with Google"
    Frontend->>Keycloak: 2. Redirect to Keycloak OAuth
    Keycloak->>Google: 3. Redirect to Google OAuth
    Google->>Customer: 4. Display Google login/consent
    Customer->>Google: 5. Sign in & grant permission
    Google->>Keycloak: 6. Redirect with auth code
    Keycloak->>Google: 7. Exchange code for token
    Google-->>Keycloak: 8. Return access token
    Keycloak->>Google: 9. Get user profile
    Google-->>Keycloak: 10. Return profile (email, name)
    Keycloak->>Keycloak: 11. Check if user exists
    alt New user
        Keycloak->>Keycloak: 12. Create user account
        Keycloak->>Keycloak: 13. Trigger REGISTER event
        Keycloak->>EventListener: 14. Event notification
        EventListener->>Backend: 15. POST /keycloak/webhook/user-registration
        Backend->>Database: 16. Create User record
        Database-->>Backend: 17. User saved
    else Existing user
        Keycloak->>Keycloak: Authenticate existing user
    end
    Keycloak->>Keycloak: 18. Generate JWT tokens
    Keycloak->>Frontend: 19. Redirect with auth code
    Frontend->>Keycloak: 20. Exchange code for tokens
    Keycloak-->>Frontend: 21. Return access_token & id_token
    Frontend->>Frontend: 22. Store tokens in localStorage
    Frontend->>Customer: 23. Redirect to homepage
```

---

## Summary

### Actors Involved

- **Customer**: End user interacting with the system
- **Frontend Application**: React-based web application
- **Keycloak**: Identity and Access Management server
- **Backend API**: Spring Boot REST API
- **Database**: PostgreSQL database
- **Email Service**: Email delivery service
- **Google**: Google OAuth2 service
- **Custom Event Listener**: Keycloak extension for webhook notifications

### Key Technologies

- **OAuth2/OIDC**: Authentication protocol
- **JWT**: Token-based authentication
- **Webhook**: Event-driven user synchronization
- **React OIDC Context**: Frontend authentication library
- **Spring Security**: Backend security framework

### Common Patterns

1. **Token-based Authentication**: All use cases use JWT tokens for stateless authentication
2. **Webhook Synchronization**: User registration triggers webhook to sync data to Backend database
3. **Redirect Flow**: OAuth2 authorization code flow with redirects
4. **Error Handling**: Comprehensive error handling at each step
5. **Security**: Password complexity, token expiration, account locking
